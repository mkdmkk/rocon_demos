<!doctype html>
<html>
<head>
    <title>Cafe Solution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.css">

    <!--<link rel="stylesheet" href="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.css">-->

    <style>
        #page {
            width: 100%;
            height: 100%;
            padding: 0;
        }

        #map-canvas {
            width: 100%;
            height: 200px;
        }

        ul.list-hor {
            list-style: none;
            width: 100%;
            display: block;
        }

        ul.list-hor > li {
            width: 200px;
            list-style: none;
            float: left;
        }

        .menuitem {
            width: 100%;
        }

        div.menuitem-blk {
            text-align: center;
            font-weight: bold;
        }

        input.in-small {
            width: 40px;
        }

        .hor-children > * {
            float: left;
        }
    </style>

</head>
<body>

<div data-role="page" id="page" data-url="page">
    <div data-role="header" data-theme="a">
        <h1>Cafe Remote Order App</h1>
    </div>
    <div role="main" class="ui-content" id="map-canvas">
        <!-- map loads here... -->
    </div>
    <div class="ui-corner-all custom-corners">
        <div class="ui-bar ui-bar-a">
            <h3>Menu</h3>
        </div>
        <ul data-role="listview" data-inset="true">
            <li data-icon="false">
                <img src="file:///android_asset/web/res/americano.png">

                <div style="float:left">
                    <h2>Americano</h2>

                    <p>2,000 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <input readonly="readonly" value="0" class="in-small" name="Americano">
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/iced-americano.png">

                <div style="float:left">
                    <h2>Iced Americano</h2>

                    <p>2,500 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <input readonly="readonly" value="0" class="in-small" name="Iced Americano">
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>

            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/cafe-latte.png">

                <div style="float:left">
                    <h2>Latte</h2>

                    <p>2,500 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <input readonly="readonly" value="0" class="in-small" name="Latte">
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/iced_cafe-latte.png">

                <div style="float:left">
                    <h2>Iced Latte</h2>

                    <p>3,000 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <input readonly="readonly" value="0" class="in-small" name="Iced Latte">
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
        </ul>

        <!--div class="ui-body ui-body-a">
            <ul class="list-hor">
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/americano.png"><br>Americano</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/iced-americano.png"><br>Iced Americano</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/cafe-latte.png"><br>Latte</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/iced_cafe-latte.png"><br>Iced Latte</div></li>
            </ul>
        </div-->
    </div>
    <div>
        <div style="float: left; width: 70%">
            <input id="server-addr" placeholder="Server Address (Do not put any protocol prefix like 'http')">
        </div>
        <div style="float: right; width: 25%">
            <button class="ui-btn" id="btn-order">Order</button>
        </div>
    </div>

    <div class="ui-corner-all custom-corners">
        <div class="ui-bar ui-bar-a">
            <h3>Expectation</h3>
        </div>
        <div>
            <label>Expected Arrival Time:</label><input readonly="readonly" id="arrival-time">
            <label>Remained Time:</label><input readonly="readonly" id="remained-time">
        </div>
    </div>
</div>

<!--<script src="file:///android_asset/web/lib/jquery-1.11.0.min.js"></script>-->
<!--<script src="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.js"></script>-->
<!--<script src="file:///android_asset/web/lib/moment-with-langs.min.js"></script>-->

<script src="./lib/jquery-1.11.0.min.js"></script>
<script src="./lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.js"></script>
<script src="./lib/moment-with-langs.min.js"></script>

<script src="http://maps.google.com/maps/api/js?sensor=false"></script>

<!--<script src="file:///android_asset/web/lib/roslibjs-devel/include/EventEmitter2/eventemitter2.js"></script>-->
<!--<script src="file:///android_asset/web/lib/roslibjs-devel/build/roslib.js"></script>-->

<script src="./lib/roslibjs-devel/include/EventEmitter2/eventemitter2.js"></script>
<script src="./lib/roslibjs-devel/build/roslib.js"></script>

<script type="text/javascript">
    /*
     * Google Maps documentation: http://code.google.com/apis/maps/documentation/javascript/basics.html
     * Geolocation documentation: http://dev.w3.org/geo/api/spec-source.html
     */
    $(document).on("pageinit", "#page", function () {
        var ros = new ROSLIB.Ros();
        var orderUID; // uid of order

        // ------------------------------------------------
        // Event handlers
        // ------------------------------------------------
        $("#btn-order").click(function() {
            calcRoute(false);
        });
        $(".btn-minus").click(function () {
            numIn = $(this).parent().find("input.in-small");
            num = Number(numIn.attr("value"));
            if (num > 0) {
                numIn.attr("value", num - 1);
            }
        });
        $(".btn-plus").click(function () {
            numIn = $(this).parent().find("input.in-small");
            num = Number(numIn.attr("value"));
            numIn.attr("value", num + 1);
        });

        // ------------------------------------------------
        // Navigation
        // ------------------------------------------------
        // Location of Soongsil Univ.: 37.496375,126.956879
        var lastLocation = new google.maps.LatLng(37.496375, 126.956879); // Soongsil Univ.
        var directionsDisplay = new google.maps.DirectionsRenderer();
        var directionsService = new google.maps.DirectionsService();

        if (navigator.geolocation) {
            function success(pos) {
                // Location found, show map with these coordinates
                lastLocation = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                drawMap(lastLocation);
            }

            function fail(error) {
                drawMap(lastLocation);  // Failed to find location, show default map
            }

            // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
            navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy: true, timeout: 6000});
        } else {
            drawMap(defaultLatLng);  // No geolocation support, show default map
        }

        // ------------------------------------------------
        // Functions
        // ------------------------------------------------
        function calcRoute(isUpdating) {
            var orderInfo;
            if(!isUpdating) {
                orderInfo = packOrderMenu();
                if(orderInfo == undefined || orderInfo == null) {
                    alert("No order item exists.");
                    return;
                }
            }

            // Location of the cafe: 37.476025,126.882318
            var end = new google.maps.LatLng(37.476025, 126.882318);

            var request = {
                origin: lastLocation,
                destination: end,
                provideRouteAlternatives: false,
                travelMode: google.maps.TravelMode.TRANSIT
            };

            directionsService.route(request, function (response, status) {
//                alert(status);
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    // alert(JSON.stringify(response));
                    // Time Zone: response.routes[0].legs[0].arrival_time.time_zone
                    // Value: response.routes[0].legs[0].arrival_time.value

                    arrivalTime = new Date(response.routes[0].legs[0].arrival_time.value);
                    if(isUpdating == undefined || isUpdating == false) {
                        // Pack menus
                        order(orderInfo, arrivalTime);
                    } else {
                        updateOrder(arrivalTime);
                        if(arrivalTime < 5) {
                            stopOrderUpdating();
                        }
                    }
                }
            });

        }

        function packOrderMenu() {
            var order = [];
            var total = 0;
            $("input.in-small").each(function() {
               // alert($(this).attr("value"));
                qty = parseInt($(this).attr("value"));
                total += qty;
                order.push({name:$(this).attr("name"), size:2, qty:qty});
            });
            if(total > 0) {
                return order;
            } else {
                return;
            }
        }

        function order(menuItems, expectedArrivalTime) {

            // Display expected arrival time
            ms = moment(expectedArrivalTime).diff(moment(new Date()));
            remainedTime = Math.round(moment.duration(ms).asMinutes());
            $("#arrival-time").attr("value", moment(expectedArrivalTime).format("YYYY-MM-DD HH:mm A"));
            $("#remained-time").attr("value", remainedTime+" minutes");

            // ROS topics and messages
            var orderTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order',
                messageType : 'cafe_msgs/RemoteOrder'
            });

            orderUID = guid();
            var orderMsg = new ROSLIB.Message({
                name: orderUID,
                time: moment(new Date()).format("MMDDHHmm"),
                estimated_arrival: parseInt(remainedTime),
                menus: menuItems,
                status: 0
            });

            // Create a connection to the rosbridge WebSocket server.
            serverAddr = $("input#server-addr").val();
            if(serverAddr == undefined || serverAddr == "") {
                ros.connect('ws://localhost:9090');
            } else {
                ros.connect('ws://'+serverAddr);
            }
            orderTopic.publish(orderMsg);


            var orderStatusTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order_status',
                messageType : 'cafe_msgs/RemoteOrderStatus'
            });

//            orderStatusTopic.subscribe(function(message) {
////                alert(message.data);
////                listener.unsubscribe();
//            });

            // Start updating order
            stopOrderUpdating();
            orderUpdatingTimer = setInterval(startUpdating, 60000);
        }

        var orderUpdatingTimer;
        function startUpdating() {
            calcRoute(true);
        }

        function updateOrder(expectedArrivalTime) {
            ms = moment(expectedArrivalTime).diff(moment(new Date()));
            remainedTime = Math.round(moment.duration(ms).asMinutes());

            // ROS topics and messages
            var orderUpdateTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order_update',
                messageType : 'cafe_msgs/RemoteOrderUpdate'
            });

            var orderUpdateMsg = new ROSLIB.Message({
                name: orderUID,
                estimated_arrival: parseInt(remainedTime),
                status: 0
            });

            orderUpdateTopic.publish(orderUpdateMsg);
        }

        function stopOrderUpdating() { // to be called when you want to stop the timer
            clearInterval(orderUpdatingTimer);
        }

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                    s4() + '-' + s4() + s4() + s4();
        }

        function drawMap(latlng, isForRoute) {
            var myOptions = {
                zoom: 10,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
            directionsDisplay.setMap(map);

            if (isForRoute == undefined || !isForRoute) {
                // Add an overlay to the map of current lat/lng
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    title: "Greetings!"
                });
            }
        }

        function pad(num, size) {
            var s = num+"";
            while (s.length < size) s = "0" + s;
            return s;
        }
    });
</script>
</body>
</html>